#!@PYTHON_EXECUTABLE@

from subprocess import call
import os
import datetime

def get_timestamp():
    now = datetime.datetime.utcnow()
    return now.replace(microsecond=0).isoformat()

def main():
    os.chdir(os.path.dirname(sys.argv[0]))
    call(["env", "-i", "bash", "-c", "(source testing-env.sh; env >test.env)"])
    apps = [ "md5sum", "mknod", "mkfifo", "mkdir", "paste", "ptx", "pr" ]
    log_dir = os.path.join("logs", get_timestamp())
    os.makedirs(log_dir)
    for app in apps:
      call(["@KLEE_BINARY@"]
           + DEFAULT_ARGS
           + [ "--output=%s" % os.path.join(log_dir, proc),
               os.path.join("coreutils-6.10-llvm-prefix", "bin", app + ".bc")]
           + SYM_ARGS)

DEFAULT_ARGS = [
    "--simplify-sym-indices"
    "--write-cvcs"
    "--write-cov"
    "--output-module"
    "--disable-inlining"
    "--optimize"
    "--use-forked-solver"
    "--use-cex-cache"
    "--libc=uclibc"
    "--posix-runtime"
    "--allow-external-sym-calls"
    "--only-output-states-covering-new"
    "--environ=test.env"
    "--run-in=sandbox"
    "--max-sym-array-size=4096"
    "--max-instruction-time=3."
    "--max-memory=4000"
    "--max-time=60."
    "--watchdog"
    "--max-memory-inhibit=false"
    "--max-static-fork-pct=1"
    "--max-static-solve-pct=1"
    "--max-static-cpfork-pct=1"
    "--switch-type=internal"
    "--search=random-path"
    "--search=nurs:covnew"
    "--use-batching-search"
    "--batch-instructions=10000"
    "--emit-all-errors"
    "--write-paths"
]

SYM_ARGS = [
    "--sym-args 0 1 10"
    "--sym-args 0 2 2"
    "--sym-files 1 8"
    "--sym-stdin 8"
    "--sym-stdout"
]

   #--max-instruction-time=60. \
   #--max-memory=4000 \
   #--max-time=3600. \

#prog=$1
#shift
#
#@KLEE_BINARY@ "$@" \
#    --simplify-sym-indices \
#    --write-cvcs \
#    --write-cov \
#    --output-module \
#    --disable-inlining \
#    --optimize \
#    --use-forked-solver \
#    --use-cex-cache \
#    --libc=uclibc \
#    --posix-runtime \
#    --allow-external-sym-calls \
#    --only-output-states-covering-new \
#    --environ=test.env \
#    --run-in=sandbox \
#    --max-sym-array-size=4096 \
#    --max-instruction-time=320. \
#    --max-memory=10000 \
#    --max-time=28800. \
#    --watchdog \
#    --max-memory-inhibit=false \
#    --max-static-fork-pct=1 \
#    --max-static-solve-pct=1 \
#    --max-static-cpfork-pct=1 \
#    --switch-type=internal \
#    --search=random-path \
#    --search=nurs:covnew \
#    --use-batching-search \
#    --batch-instructions=10000 \
#    --emit-all-errors \
#    --write-paths \
#    --output=logs/$(date -u +"%Y-%m-%dT%H:%M:%SZ")-$prog \
#    "./coreutils-6.10-llvm-prefix/bin/$prog" \
#    --sym-args 0 1 10 \
#    --sym-args 0 2 2  \
#    --sym-files 1 8 \
#    --sym-stdin 8 \
#    --sym-stdout
#   #--max-instruction-time=60. \
#   #--max-memory=4000 \
#   #--max-time=3600. \
